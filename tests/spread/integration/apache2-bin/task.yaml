summary: Integration tests for apache2-bin

execute: |
  rootfs="$(install-slices apache2-bin_bins base-passwd_data)"

  chroot "${rootfs}/" apache2 -v

  mkdir -p "${rootfs}/dev"
  mount --rbind /dev "${rootfs}/dev"
  mkdir -p "${rootfs}/etc/apache2"
  mkdir -p "${rootfs}/etc/apache2/logs"
  mkdir -p "${rootfs}/var/run/apache2"
  mkdir -p "${rootfs}/var/lock/apache2"
  mkdir -p "${rootfs}/var/log/apache2"
  mkdir -p "${rootfs}/var/www/html"

  chown www-data:www-data "${rootfs}/var/run/apache2"
  chown www-data:www-data "${rootfs}/var/lock/apache2"
  chown www-data:www-data "${rootfs}/var/log/apache2"
  chown -R www-data:www-data "${rootfs}/var/www"

  chmod 755 "${rootfs}/var/run/apache2"
  chmod 755 "${rootfs}/var/lock/apache2"
  chmod 755 "${rootfs}/var/log/apache2"
  chmod -R 755 "${rootfs}/var/www"

  echo "Hello, Apache!" > "${rootfs}/var/www/html/index.html"
  test "$(chroot "${rootfs}" apache2 -t 2>&1 )" = "Syntax OK"
  chroot "${rootfs}" apache2 -k start
  test "$(curl -s -o /dev/null -w "%{http_code}\n" 127.0.0.1:8080)" = "200"
  chroot "${rootfs}" apache2 -k stop
  umount -l "${rootfs}/dev"
