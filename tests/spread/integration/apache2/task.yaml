summary: Integration tests for apache2

execute: |
  rootfs="$(install-slices apache2_bins base-passwd_data findutils_bins)"

  mkdir -p "${rootfs}/dev"
  mount --rbind /dev "${rootfs}/dev"
  cat <<'EOF' > "${rootfs}/etc/apache2/apache2.conf"
  ServerRoot /etc/apache2
  ServerName localhost:8080
  Listen 8080
  LoadModule mpm_event_module /usr/lib/apache2/modules/mod_mpm_event.so
  LoadModule authz_core_module /usr/lib/apache2/modules/mod_authz_core.so
  LoadModule dir_module /usr/lib/apache2/modules/mod_dir.so
  ErrorLog /var/log/apache2/error.log
  User www-data
  Group www-data
  DocumentRoot "/var/www/html"
  <Directory "/var/www/html">
      Options Indexes FollowSymLinks
      AllowOverride None
      Require all granted
  </Directory>
  EOF
  test "$(chroot "${rootfs}/" apache2 -t 2>&1 >/dev/null)" = "Syntax OK"
  test "$(chroot "${rootfs}" a2query -M)" = "event"
  test "$(chroot "${rootfs}" a2enmod mpm_event | tail -n -1)" = "Module mpm_event already enabled"
  test "$(chroot "${rootfs}" a2dismod mpm_prefork)" = "Module mpm_prefork already disabled"
  test "$(chroot "${rootfs}" a2dissite 000-default | head -n 1)" = "Site 000-default disabled."
  test "$(chroot "${rootfs}" a2ensite 000-default | head -n 1)" = "Enabling site 000-default."
  test "$(chroot "${rootfs}" a2disconf charset | head -n 1)" = "Conf charset disabled."
  test "$(chroot "${rootfs}" a2enconf charset | head -n 1)" = "Enabling conf charset."
  echo "Hello, Apache is working!" > "${rootfs}/var/www/html/index.html"
  chroot "${rootfs}" apache2ctl start
  apt update
  apt install net-tools iproute2 -y
  ss -tulnp | grep apache2
  curl -v localhost:8080
  cat "${rootfs}/var/log/apache2/error.log"
  test "$(curl -s -o /dev/null -w "%{http_code}\n" localhost:8080)" = "200"
